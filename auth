#!/usr/bin/env php
<?php

use function Termwind\render;

$autoloadFile = __DIR__.'/vendor/autoload.php';

const AUTH_HOST = 'https://catchadmin.vip/account/auth';

// æä¾›ä¸€ä¸ªå»ºè®®å®‰è£…æ¨¡å¼
function auth($email, $license)
{
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, AUTH_HOST);

    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query([
        'email' => $email,
        'password' => $license,
    ]));

    curl_setopt($ch, CURLOPT_POST, 1);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/x-www-form-urlencoded',
    ]);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);

    $res = curl_exec($ch);

    if (curl_errno($ch) || $res == 'fail') {
        return false;
    }

    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);

    if ($code == 200) {
        $authjson = [
            'http-basic' => [
                'satis.catchadmin.com' => [
                    'username' => $email,
                    'password' => $license,
                ],
            ],

        ];

        if (file_put_contents('auth.json', json_encode($authjson, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT))) {
            // é…ç½®å…¨å±€é•œåƒ
            // echo 'é»˜è®¤é…ç½®è…¾è®¯äº‘é•œåƒ'.PHP_EOL;
            // shell_exec('composer config -g repos.packagist composer https://mirrors.tencent.com/composer/');
            echo PHP_EOL;
            echo 'å®‰è£…ä¾èµ–'.PHP_EOL;
            echo PHP_EOL;
            shell_exec('composer install --ignore-platform-reqs');
            echo PHP_EOL;
        }

        return true;
    } else {
        return false;
    }
}

function install($argv): void
{
    if (! isset($argv[1])) {
        exit('é‚®ç®±ä¸èƒ½ä¸ºç©º');
    }

    if (! isset($argv[2])) {
        exit('æˆæƒç ä¸èƒ½ä¸ºç©º');
    }

    $email = $argv[1];
    $license = $argv[2];

    if (! filter_var($email, FILTER_VALIDATE_EMAIL)) {
        exit('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
    }

    if (strlen($license) < 16) {
        exit('æˆæƒç ä¸æ­£ç¡®');
    }

    $res = auth($email, $license);
    if (! $res) {
        echo 'ğŸ˜­ æˆæƒå¤±è´¥';
        echo PHP_EOL;
        echo "è¯·æ£€æŸ¥ä½¿ç”¨è¯¥ğŸ‘‰é‚®ç®± {$email} å’ŒğŸ‘‰æˆæƒç  {$license} æ˜¯å¦æ­£ç¡®";
        echo PHP_EOL;
        echo 'å¦‚æœæ­£ç¡®ï¼Œè¯·æ£€æŸ¥ IP ç™½åå•æ˜¯å¦æ·»åŠ ï¼š https://catchadmin.vip/user/ip ';
        echo PHP_EOL;
        echo 'æˆæƒç è·å–: https://catchadmin.vip/user/license';
    }
}

function info($autoloadFile)
{
    require $autoloadFile;

    render(
        <<<'HTML'
            <div>
                <div class="px-1 bg-indigo-700">ä¸“ä¸šç‰ˆ</div>
                <em class="ml-1">
                    <em class="text-green-700 font-bold">ğŸ‰ ä½¿ç”¨ã€Œ php artisan catch:install ã€å®‰è£…é¡¹ç›®</em>
                </em>
            </div>
HTML
    );
}

if (! file_exists($autoloadFile)) {
    install($argv);
}

if (file_exists($autoloadFile)) {
    info($autoloadFile);
}
